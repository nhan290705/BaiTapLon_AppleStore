@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}
@{
    ViewData["Title"] = "Product";
    Layout = "~/Areas/Admin/Views/Shared/MyLayout.cshtml";
}

@* <div class="row clearfix">
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <div class="card">
            <div class="header">
                <h2>
                    STRIPED ROWS
                    <small>Use <code>.table-striped</code> to add zebra-striping to any table row within the <code>&lt;tbody&gt;</code></small>
                </h2>
                <ul class="header-dropdown m-r--5">
                    <li class="dropdown">
                        <a href="javascript:void(0);" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
                            <i class="material-icons">more_vert</i>
                        </a>
                        <ul class="dropdown-menu pull-right">
                            <li><a href="javascript:void(0);">Action</a></li>
                            <li><a href="javascript:void(0);">Another action</a></li>
                            <li><a href="javascript:void(0);">Something else here</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="body table-responsive">
                <table class="table table-striped table-hover" id="product-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Product Name</th>
                            <th>Color</th>
                            <th>Port</th>
                            <th>Ram</th>
                            <th>Qty</th>
                            <th>Discount</th>
                            <th>Price</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <nav aria-label="Page navigation">
                    <ul id="custom-pagination" class="pagination pagination-outline-primary">
                        <li class="page-item first">
                            <a class="page-link" href="javascript:void(0);">
                                <i class="tf-icon ri-skip-back-mini-line ri-22px"></i>
                            </a>
                        </li>
                        <li class="page-item prev">
                            <a class="page-link" href="javascript:void(0);">
                                <i class="tf-icon ri-arrow-left-s-line ri-22px"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="javascript:void(0);">1</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="javascript:void(0);">2</a>
                        </li>
                        <li class="page-item active">
                            <a class="page-link" href="javascript:void(0);">3</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="javascript:void(0);">4</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="javascript:void(0);">5</a>
                        </li>
                        <li class="page-item next">
                            <a class="page-link" href="javascript:void(0);">
                                <i class="tf-icon ri-arrow-right-s-line ri-22px"></i>
                            </a>
                        </li>
                        <li class="page-item last">
                            <a class="page-link" href="javascript:void(0);">
                                <i class="tf-icon ri-skip-forward-mini-line ri-22px"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Jquery Core Js -->
<script src="~/template/plugins/jquery/jquery.min.js"></script>

<script src="~/template/js/render-pagination.js"></script>
<script src="~/template/js/common.js"></script>
<script>
    let pageIndex = 1, pageSize = 10, totalRecords = 0;
    let sortBy = 'ProductName', isAsc = true;
    let keyword = ''; // nếu bạn có ô input search thì lấy từ đó

    $(document).ready(function () {
        fetchData();
    });

    function fetchData() {
        const req = {
            pageIndex: pageIndex,
            pageSize: pageSize,
            sortBy: sortBy,
            isAsc: isAsc,
            name: keyword
        };
        showLoading();
        $.ajax({
            url: '/Admin/Product/Search',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(req),
            success: function (res) {
                console.log(res);
                // --- Trường hợp A: API trả về PagedResult { items, totalRecords, pageIndex, pageSize }
                if (res && res.products && Array.isArray(res.products)) {
                    renderTable(res.products, res.pageIndex, res.pageSize);
                    renderPaginationBSB({
                        totalRecords: res.totalRecords,
                        pageIndex: res.pageIndex,
                        pageSize: res.pageSize
                    }, '#custom-pagination', changePageIndex);
                }
                hideLoading();
            },
            error: function (xhr) {
                hideLoading();
                console.error(xhr);
                alert('Có lỗi khi tải dữ liệu sản phẩm.');
            }
        });
    }

    function changePageIndex(totalRecords, newPage, newSize) {
        pageIndex = newPage;
        pageSize = newSize;
        totalRecords = totalRecords;
        fetchData();
    }

    function renderTable(items, curPage, size) {
        const $tbody = $('#product-table tbody');
        $tbody.empty();

        if (!items || items.length === 0) {
            $tbody.append(`<tr><td colspan="9" class="text-center">No data</td></tr>`);
            return;
        }

        // STT theo trang: tính từ 1
        let startNo = (curPage - 1) * size;

        items.forEach((p, idx) => {
            $tbody.append(`
                <tr>
                    <td>${startNo + idx + 1}</td>
                    <td>${escapeHtml(p.productName)}</td>
                    <td>${escapeHtml(p.color ?? '')}</td>
                    <td>${escapeHtml(p.port ?? '')}</td>
                    <td>${p.ram ?? ''}</td>
                    <td>${p.qty ?? ''}</td>
                    <td>${formatNumber(p.discount ?? 0)}</td>
                    <td>${formatNumber(p.price ?? 0)}</td>
                    <td>
                        <button type="button" class="btn btn-warning btn-sm" data-id="${p.productId}">
                            <i class="ri-pencil-line"></i> Update
                        </button>
                    </td>
                </tr>
            `);
        });
    }

    // Helpers
    function escapeHtml(str) {
        if (str == null) return '';
        return String(str)
            .replaceAll('&', '&amp;')
            .replaceAll('<', '&lt;')
            .replaceAll('>', '&gt;')
            .replaceAll('"', '&quot;')
            .replaceAll("'", '&#39;');
    }

    function formatNumber(n) {
        // tuỳ locale của bạn
        try {
            return Number(n).toLocaleString('vi-VN');
        } catch {
            return n;
        }
    }
</script> *@
