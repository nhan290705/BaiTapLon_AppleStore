@{
    ViewData["Title"] = "Đổi mật khẩu";
    Layout = "~/Areas/Admin/Views/Shared/MyLayout.cshtml";
    var user = ViewBag.User as ProjectBuySmartPhone.Models.Domain.Entities.User;
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-key"></i> Đổi mật khẩu khách hàng</h2>
        <a asp-action="Details" asp-route-id="@user.UserId" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Quay lại
        </a>
    </div>

    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            <button type="button" class="close" data-dismiss="alert">&times;</button>
            <ul class="mb-0">
                @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                {
                    <li>@error.ErrorMessage</li>
                }
            </ul>
        </div>
    }

    <div class="row justify-content-center">
        <div class="col-lg-6">
            <!-- User Info Card -->
            <div class="card border mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-user"></i> Thông tin khách hàng</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="avatar-circle mr-3">
                            @if (!string.IsNullOrEmpty(user.LastName))
                            {
                                @user.LastName.Substring(0, 1).ToUpper()
                            }
                            else
                            {
                                <span>?</span>
                            }
                        </div>
                        <div>
                            <h5 class="mb-0">@user.LastName</h5>
                            <p class="text-muted mb-0">@user.Email</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Change Password Form -->
            <div class="card border mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-lock"></i> Mật khẩu mới</h5>
                </div>
                <div class="card-body">
                    <form asp-action="ChangePassword" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="userId" value="@user.UserId" />

                        

                        <div class="form-group">
                            <label class="font-weight-bold">
                                Mật khẩu mới <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input type="password" name="newPassword" id="newPassword"
                                       class="form-control border" required
                                       placeholder="Nhập mật khẩu mới (tối thiểu 6 ký tự)" />
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button"
                                            onclick="togglePassword('newPassword', this)">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <span class="text-danger">@Html.ValidationMessage("newPassword")</span>
                            <small class="form-text text-muted">
                                Mật khẩu phải có ít nhất 6 ký tự
                            </small>
                        </div>

                        <div class="form-group">
                            <label class="font-weight-bold">
                                Xác nhận mật khẩu <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input type="password" name="confirmPassword" id="confirmPassword"
                                       class="form-control border" required
                                       placeholder="Nhập lại mật khẩu mới" />
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button"
                                            onclick="togglePassword('confirmPassword', this)">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <span class="text-danger">@Html.ValidationMessage("confirmPassword")</span>
                        </div>

                        <!-- Password Strength Indicator -->
                        <div class="form-group">
                            <label class="font-weight-bold">Độ mạnh mật khẩu:</label>
                            <div class="progress" style="height: 25px;">
                                <div id="passwordStrength" class="progress-bar" role="progressbar"
                                     style="width: 0%"></div>
                            </div>
                            <small id="strengthText" class="form-text text-muted"></small>
                        </div>

                        <hr>

                        <div class="form-group mb-0">
                            <button type="submit" class="btn btn-primary btn-block btn-lg">
                                <i class="fas fa-save"></i> Đổi mật khẩu
                            </button>
                            <a asp-action="Details" asp-route-id="@user.UserId"
                               class="btn btn-secondary btn-block btn-lg mt-2">
                                <i class="fas fa-times"></i> Hủy
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Security Tips -->
            <div class="card border mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-shield-alt"></i> Gợi ý bảo mật</h5>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>Sử dụng mật khẩu dài ít nhất 8-12 ký tự</li>
                        <li>Kết hợp chữ hoa, chữ thường, số và ký tự đặc biệt</li>
                        <li>Không sử dụng thông tin cá nhân dễ đoán</li>
                        <li>Không sử dụng lại mật khẩu cũ</li>
                        <li>Thay đổi mật khẩu định kỳ để bảo mật tốt hơn</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // Toggle password visibility
        function togglePassword(inputId, button) {
            const input = document.getElementById(inputId);
            const icon = button.querySelector('i');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Check password strength
        document.getElementById('newPassword').addEventListener('input', function(e) {
            const password = e.target.value;
            const strengthBar = document.getElementById('passwordStrength');
            const strengthText = document.getElementById('strengthText');

            let strength = 0;
            let text = '';
            let colorClass = '';

            if (password.length >= 6) strength += 20;
            if (password.length >= 8) strength += 20;
            if (/[a-z]/.test(password)) strength += 20;
            if (/[A-Z]/.test(password)) strength += 20;
            if (/[0-9]/.test(password)) strength += 10;
            if (/[^a-zA-Z0-9]/.test(password)) strength += 10;

            if (strength < 40) {
                text = 'Yếu';
                colorClass = 'bg-danger';
            } else if (strength < 60) {
                text = 'Trung bình';
                colorClass = 'bg-warning';
            } else if (strength < 80) {
                text = 'Khá';
                colorClass = 'bg-info';
            } else {
                text = 'Mạnh';
                colorClass = 'bg-success';
            }

            strengthBar.style.width = strength + '%';
            strengthBar.className = 'progress-bar ' + colorClass;
            strengthBar.textContent = text;
            strengthText.textContent = text;
            strengthText.className = 'form-text ' + colorClass.replace('bg-', 'text-');
        });

        // Validate confirm password
        document.getElementById('confirmPassword').addEventListener('input', function(e) {
            const password = document.getElementById('newPassword').value;
            const confirm = e.target.value;

            if (password !== confirm) {
                e.target.setCustomValidity('Mật khẩu xác nhận không khớp!');
            } else {
                e.target.setCustomValidity('');
            }
        });

        // Form validation
        document.querySelector('form').addEventListener('submit', function(e) {
            const password = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;

            if (password.length < 6) {
                e.preventDefault();
                alert('Mật khẩu phải có ít nhất 6 ký tự!');
                return false;
            }

            if (password !== confirm) {
                e.preventDefault();
                alert('Mật khẩu xác nhận không khớp!');
                return false;
            }

            return true;
        });
    </script>

    <style>
        .card.border {
            border: 1px solid #dee2e6 !important;
        }

        .form-control.border {
            border: 1px solid #ced4da !important;
        }

        .avatar-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 24px;
        }

        .progress-bar {
            transition: width 0.3s ease, background-color 0.3s ease;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
}