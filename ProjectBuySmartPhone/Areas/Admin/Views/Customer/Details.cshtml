@model ProjectBuySmartPhone.Models.Domain.Entities.User
@{
    ViewData["Title"] = "Chi tiết khách hàng";
    Layout = "~/Areas/Admin/Views/Shared/MyLayout.cshtml";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-user"></i> Chi tiết khách hàng</h2>
        <div>
            <a asp-action="Edit" asp-route-id="@Model.UserId" class="btn btn-warning">
                <i class="fas fa-edit"></i> Sửa thông tin
            </a>
            <a asp-action="ChangePassword" asp-route-id="@Model.UserId" class="btn btn-primary">
                <i class="fas fa-key"></i> Đổi mật khẩu
            </a>
            <a asp-action="Index" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Quay lại
            </a>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            <button type="button" class="close" data-dismiss="alert">&times;</button>
            @TempData["SuccessMessage"]
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            <button type="button" class="close" data-dismiss="alert">&times;</button>
            @TempData["ErrorMessage"]
        </div>
    }

    <div class="row">
        <!-- Thông tin cá nhân -->
        <div class="col-lg-6">
            <div class="card border mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-id-card"></i> Thông tin cá nhân</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="avatar-circle-large mx-auto">
                            @if (!string.IsNullOrEmpty(Model.LastName))
                            {
                                @Model.LastName.Substring(0, 1).ToUpper()
                            }
                            else
                            {
                                <span>?</span>
                            }
                        </div>
                        <h4 class="mt-3 mb-0">@(Model.LastName ?? "N/A")</h4>
                        <p class="text-muted">@( "Customer")</p>
                    </div>

                    <table class="table table-borderless mb-0">
                        <tr>
                            <td class="font-weight-bold" style="width: 150px;">Mã KH:</td>
                            <td><strong>#@Model.UserId</strong></td>
                        </tr>
                        <tr>
                            <td class="font-weight-bold">Tên đăng nhập:</td>
                            <td>@Model.Username</td>
                        </tr>
                        <tr>
                            <td class="font-weight-bold">Email:</td>
                            <td>
                                <a href="mailto:@Model.Email">@Model.Email</a>
                            </td>
                        </tr>
                        <tr>
                            <td class="font-weight-bold">Số điện thoại:</td>
                            <td>
                                @if (!string.IsNullOrEmpty(Model.PhoneNumber))
                                {
                                    <a href="tel:@Model.PhoneNumber">@Model.PhoneNumber</a>
                                }
                                else
                                {
                                    <span class="text-muted">Chưa cập nhật</span>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td class="font-weight-bold">Địa chỉ:</td>
                            <td>@(Model.Address ?? "Chưa cập nhật")</td>
                        </tr>
                        <tr>
                            <td class="font-weight-bold">Ngày tạo:</td>
                            <td>@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                        </tr>
                        <tr>
                            <td class="font-weight-bold">Cập nhật lần cuối:</td>
                            <td>@(Model.UpdatedAt?.ToString("dd/MM/yyyy HH:mm") ?? "Chưa cập nhật")</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Thống kê đơn hàng -->
        <div class="col-lg-6">
            <div class="card border mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-shopping-cart"></i> Thống kê đơn hàng</h5>
                </div>
                <div class="card-body">
                    @{
                        var totalOrders = Model.Orders?.Count ?? 0;
                        var totalAmount = Model.Orders?.Sum(o => o.TotalPrice ?? 0) ?? 0;
                        var pendingOrders = Model.Orders?.Count(o => o.StatusOrderId == 1) ?? 0;
                        var completedOrders = Model.Orders?.Count(o => o.StatusOrderId == 4) ?? 0;
                    }

                    <div class="row text-center mb-4">
                        <div class="col-6 mb-3">
                            <div class="stat-card bg-info text-white">
                                <h2 class="mb-0">@totalOrders</h2>
                                <p class="mb-0">Tổng đơn hàng</p>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="stat-card bg-success text-white">
                                <h2 class="mb-0">@completedOrders</h2>
                                <p class="mb-0">Đã hoàn thành</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-card bg-warning text-white">
                                <h2 class="mb-0">@pendingOrders</h2>
                                <p class="mb-0">Đang xử lý</p>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-card bg-primary text-white">
                                <h4 class="mb-0">@string.Format("{0:N0}", totalAmount)</h4>
                                <p class="mb-0">Tổng chi tiêu (VNĐ)</p>
                            </div>
                        </div>
                    </div>

                    @if (Model.Orders != null && Model.Orders.Any())
                    {
                        <h6 class="border-bottom pb-2 mb-3">Đơn hàng gần đây</h6>
                        <div class="list-group">
                            @foreach (var order in Model.Orders.OrderByDescending(o => o.CreatedAt).Take(5))
                            {
                                var statusBadge = order.StatusOrderId switch
                                {
                                    1 => "badge-warning",
                                    2 => "badge-info",
                                    3 => "badge-primary",
                                    4 => "badge-success",
                                    5 => "badge-danger",
                                    _ => "badge-secondary"
                                };

                                <a href="@Url.Action("Details", "Order", new { id = order.OrderId })"
                                   class="list-group-item list-group-item-action">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>Đơn hàng #@order.OrderId</strong><br>
                                            <small class="text-muted">@order.CreatedAt.ToString("dd/MM/yyyy")</small>
                                        </div>
                                        <div class="text-right">
                                            <div><strong class="text-success">@string.Format("{0:N0}", order.TotalPrice ?? 0) VNĐ</strong></div>
                                            <span class="badge @statusBadge">@order.StatusOrder?.Name</span>
                                        </div>
                                    </div>
                                </a>
                            }
                        </div>

                        @if (totalOrders > 5)
                        {
                            <div class="text-center mt-3">
                                <a href="@Url.Action("Index", "Order", new { searchTerm = Model.UserId })"
                                   class="btn btn-sm btn-outline-primary">
                                    Xem tất cả (@totalOrders đơn hàng)
                                </a>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle"></i> Khách hàng chưa có đơn hàng nào
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="mb-5">
        <a asp-action="Edit" asp-route-id="@Model.UserId" class="btn btn-warning btn-lg px-5">
            <i class="fas fa-edit"></i> Sửa thông tin
        </a>
        <a asp-action="ChangePassword" asp-route-id="@Model.UserId" class="btn btn-primary btn-lg px-5 ml-2">
            <i class="fas fa-key"></i> Đổi mật khẩu
        </a>
        <button type="button" class="btn btn-danger btn-lg px-5 ml-2"
                onclick="confirmDelete(@Model.UserId, '@Model.LastName')">
            <i class="fas fa-trash"></i> Xóa khách hàng
        </button>
    </div>
</div>

<!-- Delete Form -->
<form id="deleteForm" method="post" asp-action="Delete">
    @Html.AntiForgeryToken()
    <input type="hidden" id="deleteUserId" name="id" />
</form>

@section Scripts {
    <script>
        function confirmDelete(userId, userName) {
            if (confirm(`Bạn có chắc chắn muốn xóa khách hàng "${userName}"?\n\nLưu ý: Không thể xóa nếu khách hàng có đơn hàng.`)) {
                document.getElementById('deleteUserId').value = userId;
                document.getElementById('deleteForm').submit();
            }
        }

        // Auto hide alerts
        setTimeout(function() {
            $('.alert').fadeOut('slow');
        }, 5000);
    </script>

    <style>
        .card.border {
            border: 1px solid #dee2e6 !important;
        }

        .avatar-circle-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 40px;
        }

        .stat-card {
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

            .stat-card h2, .stat-card h4 {
                font-weight: bold;
            }

        .list-group-item {
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }

            .list-group-item:hover {
                border-left-color: #007bff;
                background-color: #f8f9fa;
            }
    </style>
}